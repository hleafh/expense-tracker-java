<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>簡易記帳系統</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="header">
        <h1>記帳系統</h1>
        <button id="toggle-theme">🌙 深色模式</button>
    </header>

    <div class="main-layout">
        <nav class="sidebar">
            <h2>功能選單</h2>
            <ul>
                <li><a href="#" data-page="add-expense-page" class="nav-link active">
                    <i class="fas fa-plus-circle"></i> 新增支出
                </a></li>
                <li><a href="#" data-page="category-budget-page" class="nav-link">
                    <i class="fas fa-wallet"></i> 分類預算
                </a></li>
                <li><a href="#" data-page="statistics-page" class="nav-link">
                    <i class="fas fa-chart-pie"></i> 統計報表
                </a></li>
                <li><a href="#" data-page="expense-records-page" class="nav-link">
                    <i class="fas fa-list-alt"></i> 支出紀錄
                </a></li>
                <li><a href="#" data-page="data-management-page" class="nav-link">
                    <i class="fas fa-file-import"></i> 資料管理
                </a></li>
            </ul>
        </nav>

        <main class="content-area">
            <div id="add-expense-page" class="page active">
                <div class="container">
                    <form id="expenseForm">
                        <h2>新增支出</h2>
                        <label for="title">標題：</label>
                        <input type="text" id="title" required>
                        <label for="amount">金額：</label>
                        <input type="number" id="amount" step="0.01" required>
                        <label for="category">分類：</label>
                        <select id="category" required>
                            <option value="">請選擇</option>
                            <option>餐飲</option>
                            <option>交通</option>
                            <option>娛樂</option>
                            <option>購物</option>
                            <option>生活</option>
                            <option>其他</option>
                        </select>
                        <label for="date">日期：</label>
                        <input type="date" id="date" required>

                        <button type="button" class="speech-button" id="speechInputButton">
                            <i class="fas fa-microphone"></i> 開始語音輸入
                        </button>
                        <button type="button" class="speech-button recording" id="stopSpeechInputButton" style="display: none;">
                            <i class="fas fa-microphone-slash"></i> 停止語音輸入
                        </button>
                        <div id="speechLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> 語音處理中...
                        </div>

                        <button type="submit" id="addExpenseButton">新增支出</button>
                        <div id="message" class="message"></div>
                        <div id="expenseFormLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> 提交中...
                        </div>
                    </form>
                </div>
            </div>

            <div id="category-budget-page" class="page" style="display: none;">
                <div class="container">
                    <h2>設定分類預算</h2>
                    <form id="categoryBudgetForm">
                        <label for="cbYear">年份：</label>
                        <input type="number" id="cbYear" min="2000" max="2100" required>
                        <label for="cbMonth">月份：</label>
                        <input type="number" id="cbMonth" min="1" max="12" required>
                        <label for="cbCategory">分類：</label>
                        <select id="cbCategory" required>
                            <option value="">請選擇</option>
                            <option>餐飲</option>
                            <option>交通</option>
                            <option>娛樂</option>
                            <option>購物</option>
                            <option>生活</option>
                            <option>其他</option>
                        </select>
                        <label for="cbAmount">預算金額：</label>
                        <input type="number" id="cbAmount" step="0.01" min="0" required>
                        <button type="submit" id="saveBudgetButton">儲存分類預算</button>
                        <div id="categoryBudgetMessage" class="message"></div>
                        <div id="budgetFormLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> 儲存中...
                        </div>
                    </form>
                    <h3>當月分類預算概覽：</h3>
                    <p>總預算：<span id="totalMonthlyBudget">--</span></p>
                    <table id="categoryBudgetTable">
                        <thead>
                            <tr>
                                <th>分類</th>
                                <th>預算金額</th>
                            </tr>
                        </thead>
                        <tbody id="categoryBudgetTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="statistics-page" class="page" style="display: none;">
                <div class="container">
                    <h2>每月分類支出統計</h2>
                    <div>
                        <label for="statYear">年份：</label>
                        <input type="number" id="statYear" min="2000" max="2100">
                        <label for="statMonth">月份：</label>
                        <input type="number" id="statMonth" min="1" max="12">
                        <button id="loadStatsButton">查看統計</button>
                        <div id="statsLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> 載入中...
                        </div>
                    </div>

                    <h3>分類支出明細：</h3>
                    <table id="monthlyStatTable">
                        <thead>
                            <tr>
                                <th>分類</th>
                                <th>總金額</th>
                                <th>預算金額</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyStatTableBody">
                        </tbody>
                    </table>

                    <h3>支出分佈圓餅圖：</h3>
                    <div style="width: 70%; margin: 20px auto;">
                        <canvas id="expensePieChart"></canvas>
                    </div>

                    <h3>預算對比直條圖：</h3>
                    <div style="width: 70%; margin: 20px auto;">
                        <canvas id="budgetComparisonChart"></canvas>
                    </div>

                    <div id="monthlyStatMessage" class="message"></div>
                </div>
            </div>

            <div id="expense-records-page" class="page" style="display: none;">
                <div class="container">
                    <h2>支出紀錄</h2>
                    <div style="margin-bottom: 20px;">
                        <label>開始日期：</label>
                        <input type="date" id="startDate">
                        <label>結束日期：</label>
                        <input type="date" id="endDate">
                        <button id="queryExpensesButton">查詢</button>
                        <button id="resetExpensesButton">重置</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>標題</th>
                                <th>金額</th>
                                <th>分類</th>
                                <th>日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="data-management-page" class="page" style="display: none;">
                <div class="container">
                    <h2>CSV 匯入</h2>
                    <input type="file" accept=".csv" id="csvFileInput">
                    <button id="processCsvButton" style="display: none;">解析並預覽</button>

                    <div id="preview-area" style="margin-top: 1em; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; display: none;">
                        <h4>匯入預覽 (前5行)</h4>
                        <table id="csvPreviewTable" style="width:100%;">
                            <thead><tr></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button id="confirm-import" style="display: none;">開始匯入</button>
                    <div id="importMessage" class="message"></div>
                    <div id="importLoading" class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 匯入中...
                    </div>
                </div>

                <div class="container" style="margin-top: 30px;">
                    <h3>匯出資料</h3>
                    <button onclick="exportVisibleTableToCSV()">匯出 CSV</button>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2>編輯支出</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <label>標題：</label><input type="text" id="editTitle" required>
                <label>金額：</label><input type="number" id="editAmount" step="0.01" required>
                <label>分類：</label>
                <select id="editCategory" required>
                    <option>餐飲</option><option>交通</option><option>娛樂</option>
                    <option>購物</option><option>生活</option><option>其他</option>
                </select>
                <label>日期：</label><input type="date" id="editDate" required>
                <button type="submit" id="saveEditButton">儲存修改</button>
                <div id="editFormLoading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> 儲存中...
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- API URL 定義 ---
        const expenseApiUrl = '/api/expenses';
        const categoryBudgetApiUrl = '/api/category-budgets';
        const statisticsApiUrl = '/api/expenses/statistics';
        const transcribeApiUrl = '/api/speech/transcribe';

        // --- Chart.js 實例 ---
        let expensePieChartInstance = null;
        let budgetComparisonChartInstance = null;

        // --- MediaRecorder 相關變數 ---
        let mediaRecorder;
        let audioChunks = [];

        // --- 輔助函數 ---

        /**
         * 顯示訊息提示
         * @param {string} elementId - 顯示訊息的 DOM 元素 ID
         * @param {string} message - 要顯示的訊息內容
         * @param {string} type - 訊息類型 ('success', 'error', 'warning', 'info')
         * @param {number} duration - 訊息顯示的時間 (毫秒)，預設 3000ms
         */
        function showMessage(elementId, message, type, duration = 3000) {
            const msgElement = document.getElementById(elementId);
            if (!msgElement) return;

            msgElement.textContent = message;
            msgElement.className = `message ${type}`;
            clearTimeout(msgElement.timer);
            msgElement.timer = setTimeout(() => {
                msgElement.textContent = '';
                msgElement.className = 'message';
            }, duration);
        }

        /**
         * 顯示/隱藏載入指示器
         * @param {string} elementId - 載入指示器 DOM 元素 ID
         * @param {boolean} show - 是否顯示
         */
        function toggleLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        /**
         * 啟用/禁用按鈕並更新文字
         * @param {string} buttonId - 按鈕 DOM 元素 ID
         * @param {boolean} disabled - 是否禁用
         */
        function toggleButtonDisabled(buttonId, disabled) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (!button.getAttribute('data-original-text')) {
                    button.setAttribute('data-original-text', button.textContent);
                }
                button.disabled = disabled;
                button.textContent = disabled ? '處理中...' : button.getAttribute('data-original-text');
            }
        }

        /**
         * 將 Date 物件格式化為YYYY-MM-DD 字符串，並處理時區問題
         * @param {Date} dateObj - Date 物件
         * @returns {string} 格式化後的日期字符串
         */
        const formatDate = (dateObj) => {
            const year = dateObj.getUTCFullYear();
            const month = (dateObj.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getUTCDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- 核心功能函數 ---

        // 頁面切換函數
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            const currentPageElement = document.getElementById(pageId);
            if (currentPageElement) {
                currentPageElement.style.display = 'block';
            }

            // 更新導覽列的 active 狀態
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // 只有常規導覽項目才添加 active class
            const activeNavLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
            }


            // 根據切換到的頁面執行數據載入
            switch (pageId) {
                case 'expense-records-page':
                    queryExpenses(); // 載入支出紀錄
                    break;
                case 'category-budget-page':
                    loadCategoryBudgets(); // 載入分類預算
                    break;
                case 'statistics-page':
                    loadMonthlyStatistics(); // 載入每月統計
                    break;
                case 'add-expense-page':
                    // Reset date to today when entering Add Expense page
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    break;
                case 'data-management-page':
                    // Clear previous CSV state if any
                    const csvFileInput = document.getElementById('csvFileInput');
                    if (csvFileInput) csvFileInput.value = ''; // Clear selected file
                    document.getElementById('processCsvButton').style.display = 'none';
                    document.getElementById('confirm-import').style.display = 'none';
                    document.getElementById('preview-area').style.display = 'none';
                    showMessage('importMessage', '', ''); // Clear import messages
                    break;
                // 'edit-expense-page' 不再是導覽列可直接進入的頁面
                // 而是由 'expense-records-page' 中的按鈕直接觸發彈窗
            }
        }

        // 新增支出表單提交處理
        async function addExpenseHandler(e) {
            e.preventDefault();
            toggleLoading('expenseFormLoading', true);
            toggleButtonDisabled('addExpenseButton', true);

            const data = {
                title: document.getElementById('title').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };
            try {
                const res = await fetch(expenseApiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();

                if (res.ok) {
                    if (responseData.overbudget) {
                        showMessage('message', responseData.message + ' 您可以考慮調整其他預算或支出。', 'warning');
                    } else {
                        showMessage('message', responseData.message || '新增成功', 'success');
                    }
                    document.getElementById('expenseForm').reset();
                    document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Reset date to today
                    queryExpenses(); // Refresh expense records
                    loadCategoryBudgets(); // Refresh budgets display
                    loadMonthlyStatistics(); // Refresh statistics
                } else {
                    showMessage('message', responseData.message || '新增失敗', 'error');
                }
            } catch (error) {
                console.error('新增支出失敗:', error);
                showMessage('message', '新增支出失敗，請檢查網路或後端服務。', 'error');
            } finally {
                toggleLoading('expenseFormLoading', false);
                toggleButtonDisabled('addExpenseButton', false);
            }
        }

        // 分類預算表單提交處理
        async function categoryBudgetHandler(e) {
            e.preventDefault();
            toggleLoading('budgetFormLoading', true);
            toggleButtonDisabled('saveBudgetButton', true);

            const data = {
                year: parseInt(document.getElementById('cbYear').value),
                month: parseInt(document.getElementById('cbMonth').value),
                category: document.getElementById('cbCategory').value,
                amount: parseFloat(document.getElementById('cbAmount').value)
            };
            try {
                const res = await fetch(categoryBudgetApiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();
                if (res.ok) {
                    showMessage('categoryBudgetMessage', '分類預算儲存成功', 'success');
                    loadCategoryBudgets();
                    loadMonthlyStatistics();
                } else {
                    showMessage('categoryBudgetMessage', responseData.message || '分類預算儲存失敗', 'error');
                }
            } catch (error) {
                console.error('儲存分類預算失敗:', error);
                showMessage('categoryBudgetMessage', '儲存分類預算失敗，請檢查網路或後端服務。', 'error');
            } finally {
                toggleLoading('budgetFormLoading', false);
                toggleButtonDisabled('saveBudgetButton', false);
            }
        }

        // 載入分類預算概覽和總預算
        async function loadCategoryBudgets() {
            const year = parseInt(document.getElementById('cbYear').value);
            const month = parseInt(document.getElementById('cbMonth').value);

            try {
                const categoryRes = await fetch(`${categoryBudgetApiUrl}/${year}/${month}`);
                if (!categoryRes.ok) throw new Error('Failed to load category budgets');
                const categoryBudgets = await categoryRes.json();
                const categoryBudgetTableBody = document.getElementById('categoryBudgetTableBody');
                categoryBudgetTableBody.innerHTML = '';
                if (categoryBudgets.length === 0) {
                    categoryBudgetTableBody.innerHTML = '<tr><td colspan="2">本月尚無分類預算。</td></tr>';
                } else {
                    categoryBudgets.forEach(cb => {
                        categoryBudgetTableBody.innerHTML += `
                            <tr>
                                <td>${cb.category}</td>
                                <td>${cb.amount.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('載入分類預算失敗:', error);
                showMessage('categoryBudgetMessage', '載入分類預算失敗', 'error');
            }

            try {
                const totalBudgetRes = await fetch(`${categoryBudgetApiUrl}/total/${year}/${month}`);
                if (!totalBudgetRes.ok) throw new Error('Failed to load total budget');
                const totalBudgetData = await totalBudgetRes.json();
                document.getElementById('totalMonthlyBudget').textContent = totalBudgetData.totalBudget.toFixed(2) || '0.00';
            } catch (error) {
                console.error('載入總預算失敗:', error);
                document.getElementById('totalMonthlyBudget').textContent = '--';
            }
        }

        // 刪除支出紀錄
        async function deleteExpense(id) {
            if (!confirm('確定刪除這筆支出紀錄嗎？')) return;
            try {
                const res = await fetch(`${expenseApiUrl}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    // 使用新增支出頁面的訊息框來顯示刪除成功訊息
                    showMessage('message', '支出已成功刪除', 'success');
                    queryExpenses(); // Refresh expense records
                    loadCategoryBudgets(); // Refresh budgets display
                    loadMonthlyStatistics(); // Refresh statistics
                } else {
                    const errorBody = await res.json();
                    showMessage('message', errorBody.message || '刪除失敗', 'error');
                }
            } catch (error) {
                console.error('刪除失敗:', error);
                showMessage('message', '刪除支出失敗，請檢查網路或後端服務。', 'error');
            }
        }

        // 開啟編輯彈窗並載入數據
        function openEditModal(id) {
            fetch(`${expenseApiUrl}/${id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('editId').value = data.id;
                    document.getElementById('editTitle').value = data.title;
                    document.getElementById('editAmount').value = data.amount;
                    document.getElementById('editCategory').value = data.category;
                    document.getElementById('editDate').value = data.date;
                    document.getElementById('editModal').style.display = 'block'; // 顯示彈窗
                })
                .catch(error => {
                    console.error('載入編輯資料失敗:', error);
                    showMessage('message', '無法載入支出資料進行編輯。', 'error'); // 使用新增支出頁面的訊息框
                });
        }

        // 關閉編輯彈窗
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none'; // 隱藏彈窗
        }

        // 編輯表單提交處理
        async function editFormHandler(e) {
            e.preventDefault();
            toggleLoading('editFormLoading', true);
            toggleButtonDisabled('saveEditButton', true);

            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                category: document.getElementById('editCategory').value,
                date: document.getElementById('editDate').value
            };
            try {
                const res = await fetch(`${expenseApiUrl}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();
                closeEditModal(); // 不論成功或失敗都關閉編輯視窗

                if (res.ok) {
                    // 使用新增支出頁面的訊息框來顯示更新成功訊息
                    if (responseData.overbudget) {
                        showMessage('message', responseData.message + ' 您可以考慮調整其他預算或支出。', 'warning');
                    } else {
                        showMessage('message', responseData.message || '支出已更新', 'success');
                    }
                    queryExpenses();
                    loadCategoryBudgets();
                    loadMonthlyStatistics();
                } else {
                    // 使用新增支出頁面的訊息框來顯示錯誤訊息
                    showMessage('message', responseData.message || '更新失敗', 'error');
                }
            } catch (error) {
                console.error('更新失敗:', error);
                showMessage('message', '更新支出失敗，請檢查網路或後端服務。', 'error');
            } finally {
                toggleLoading('editFormLoading', false);
                toggleButtonDisabled('saveEditButton', false);
            }
        }

        // 執行日期區間查詢
        async function queryExpenses() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let url = '/api/expenses';
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();
                updateExpenseTable(data);
            } catch (error) {
                console.error('查詢失敗', error);
                // 這裡可以選擇是否在支出紀錄頁面顯示錯誤訊息
                // 例如: showMessage('expenseRecordsMessage', '載入支出紀錄失敗', 'error');
            }
        }

        // 重置日期查詢條件並重新載入所有支出
        function resetExpenses() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            queryExpenses();
        }

        // 更新支出表格內容
        function updateExpenseTable(expenses) {
            const tableBody = document.getElementById('expenseTableBody');
            tableBody.innerHTML = '';

            if (expenses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">沒有符合條件的支出紀錄。</td></tr>';
                return;
            }

            expenses.forEach(expense => {
                const row = document.createElement('tr');
                // 注意：這裡直接呼叫 openEditModal(id)
                row.innerHTML = `
                    <td>${expense.id}</td>
                    <td>${expense.title}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td>${expense.category}</td>
                    <td>${expense.date}</td>
                    <td>
                        <button class="action-button edit" onclick="openEditModal(${expense.id})">編輯</button>
                        <button class="action-button delete" onclick="deleteExpense(${expense.id})">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 載入每月支出統計數據
        async function loadMonthlyStatistics() {
            const year = document.getElementById('statYear').value;
            const month = document.getElementById('statMonth').value;
            const msg = document.getElementById('monthlyStatMessage');
            msg.textContent = '';
            toggleLoading('statsLoading', true);
            toggleButtonDisabled('loadStatsButton', true);

            if (!year || !month) {
                showMessage('monthlyStatMessage', '請選擇年份和月份。', 'error');
                toggleLoading('statsLoading', false);
                toggleButtonDisabled('loadStatsButton', false);
                return;
            }

            try {
                const res = await fetch(`${statisticsApiUrl}/${year}/${month}`);
                if (!res.ok) {
                    throw new Error('無法獲取每月統計數據。');
                }
                const data = await res.json();
                console.log('每月分類統計數據 (包含預算):', data);

                updateMonthlyStatTable(data);
                renderExpensePieChart(data);
                renderBudgetComparisonChart(data);
                showMessage('monthlyStatMessage', '每月統計數據已更新。', 'success');

            } catch (error) {
                console.error('載入每月統計失敗:', error);
                showMessage('monthlyStatMessage', `載入每月統計失敗：${error.message}`, 'error');
                updateMonthlyStatTable([]);
                renderExpensePieChart([]);
                renderBudgetComparisonChart([]);
            } finally {
                toggleLoading('statsLoading', false);
                toggleButtonDisabled('loadStatsButton', false);
            }
        }

        // 更新每月統計表格
        function updateMonthlyStatTable(statistics) {
            const tbody = document.getElementById('monthlyStatTableBody');
            tbody.innerHTML = '';

            if (statistics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">本月尚無支出紀錄。</td></tr>';
                return;
            }

            statistics.forEach(item => {
                const isOverbudget = (item.budgetAmount > 0 && item.totalAmount > item.budgetAmount);
                const statusText = isOverbudget ? '超出預算' : (item.budgetAmount > 0 ? '預算內' : '無預算');
                const rowClass = isOverbudget ? 'overbudget-row' : '';
                const totalAmountClass = isOverbudget ? 'overbudget-text' : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${item.category}</td>
                        <td class="${totalAmountClass}">${item.totalAmount.toFixed(2)}</td>
                        <td>${item.budgetAmount.toFixed(2)}</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });
        }

        // 繪製圓餅圖
        function renderExpensePieChart(statistics) {
            const ctx = document.getElementById('expensePieChart').getContext('2d');

            if (expensePieChartInstance) {
                expensePieChartInstance.destroy();
            }

            const filteredStats = statistics.filter(item => item.totalAmount > 0);

            if (filteredStats.length === 0) {
                expensePieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['無支出數據'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#cccccc'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            title: {
                                display: true,
                                text: '本月無支出數據',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                });
                return;
            }

            const labels = filteredStats.map(item => item.category);
            const data = filteredStats.map(item => item.totalAmount);
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#C9CBCE', '#A6C887', '#F08080'
            ];

            expensePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: true,
                            text: '每月分類支出分佈',
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    }
                }
            });
        }

        // 繪製預算對比直條圖
        function renderBudgetComparisonChart(statistics) {
            const ctx = document.getElementById('budgetComparisonChart').getContext('2d');

            if (budgetComparisonChartInstance) {
                budgetComparisonChartInstance.destroy();
            }

            if (statistics.length === 0) {
                budgetComparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['無數據'],
                        datasets: [{
                            label: '實際支出',
                            data: [0],
                            backgroundColor: '#cccccc'
                        }, {
                            label: '預算',
                            data: [0],
                            backgroundColor: '#999999'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            title: {
                                display: true,
                                text: '本月無支出或預算數據',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '分類',
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '金額',
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            }
                        }
                    }
                });
                return;
            }

            const labels = statistics.map(item => item.category);
            const totalAmounts = statistics.map(item => item.totalAmount);
            const budgetAmounts = statistics.map(item => item.budgetAmount || 0);

            budgetComparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '實際支出',
                        data: totalAmounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: '預算',
                        data: budgetAmounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: true,
                            text: '每月分類支出 vs. 預算對比',
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '分類',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金額',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // 語音轉文字 (傳送音訊到後端)
        async function sendAudioForTranscription(audioBlob) {
            const formData = new FormData();
            formData.append('audioFile', audioBlob, 'recorded_audio.webm');

            try {
                const res = await fetch(transcribeApiUrl, {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                const msg = document.getElementById('message');

                if (res.ok) {
                    if (data.transcription) {
                        applySpeechResultToForm(data.transcription);
                        showMessage('message', data.message || '語音轉文字成功，請確認資訊。', 'success');
                    } else {
                        showMessage('message', data.message || '語音識別結果為空，請說清楚一點。', 'warning');
                    }
                } else {
                    showMessage('message', data.message || '語音轉文字失敗。', 'error');
                }
            } catch (error) {
                console.error('發送音訊至後端失敗:', error);
                showMessage('message', '語音轉文字服務連線失敗。', 'error');
            } finally {
                toggleLoading('speechLoading', false);
            }
        }

        // 將語音辨識結果填充到表單
        function applySpeechResultToForm(speechResult) {
            const titleInput = document.getElementById('title');
            const amountInput = document.getElementById('amount');
            const categorySelect = document.getElementById('category');
            const dateInput = document.getElementById('date');
            const messageDisplay = document.getElementById('message');

            let parsedTitle = speechResult;
            let parsedAmount = null;
            let parsedCategory = null;
            let parsedDate = null;

            const today = new Date();
            const currentYear = today.getFullYear();

            let tempDateMatch;
            const specificDateRegex = /(\d{2,4})[-\/年](\d{1,2})[-\/月](\d{1,2})(?:日|號)?/;
            tempDateMatch = parsedTitle.match(specificDateRegex);
            if (tempDateMatch) {
                let year = parseInt(tempDateMatch[1]);
                let month = parseInt(tempDateMatch[2]);
                let day = parseInt(tempDateMatch[3]);
                if (year < 100) { year += 2000; }
                try {
                    const dateObj = new Date(Date.UTC(year, month - 1, day));
                    if (dateObj.getUTCFullYear() === year && (dateObj.getUTCMonth() + 1) === month && dateObj.getUTCDate() === day) {
                        parsedDate = formatDate(dateObj);
                        parsedTitle = parsedTitle.replace(tempDateMatch[0], '').trim();
                    }
                } catch (e) { /* Ignore invalid date */ }
            }

            if (!parsedDate) {
                const monthDayRegex = /(\d{1,2})月(\d{1,2})(?:日|號)?/;
                tempDateMatch = parsedTitle.match(monthDayRegex);
                if (tempDateMatch) {
                    let month = parseInt(tempDateMatch[1]);
                    let day = parseInt(tempDateMatch[2]);
                    let year = currentYear;
                    try {
                        const dateObj = new Date(Date.UTC(year, month - 1, day));
                        if (dateObj.getUTCFullYear() === year && (dateObj.getUTCMonth() + 1) === month && dateObj.getUTCDate() === day) {
                            parsedDate = formatDate(dateObj);
                            parsedTitle = parsedTitle.replace(tempDateMatch[0], '').trim();
                        }
                    } catch (e) { /* Ignore invalid date */ }
                }
            }

            if (!parsedDate) {
                const tomorrowDate = new Date(today); tomorrowDate.setDate(today.getDate() + 1);
                const yesterdayDate = new Date(today); yesterdayDate.setDate(today.getDate() - 1);
                const twoDaysAgoDate = new Date(today); twoDaysAgoDate.setDate(today.getDate() - 2);

                if (parsedTitle.includes('今天')) {
                    parsedDate = formatDate(today);
                    parsedTitle = parsedTitle.replace('今天', '').trim();
                } else if (parsedTitle.includes('昨天')) {
                    parsedDate = formatDate(yesterdayDate);
                    parsedTitle = parsedTitle.replace('昨天', '').trim();
                } else if (parsedTitle.includes('前天')) {
                    parsedDate = formatDate(twoDaysAgoDate);
                    parsedTitle = parsedTitle.replace('前天', '').trim();
                } else if (parsedTitle.includes('明天')) {
                    parsedDate = formatDate(tomorrowDate);
                    parsedTitle = parsedTitle.replace('明天', '').trim();
                }
            }

            const amountMatch = parsedTitle.match(/(\d+(\.\d+)?)\s*(元|塊錢|塊|錢)?/);
            if (amountMatch) {
                parsedAmount = parseFloat(amountMatch[1]);
                parsedTitle = parsedTitle.replace(amountMatch[0], '').trim();
            }

            const availableCategories = Array.from(categorySelect.options).map(opt => opt.value).filter(v => v !== '');
            const categoryKeywords = {
                '餐飲': ['餐飲', '午餐', '晚餐', '早餐', '咖啡', '飲料', '食物', '外賣', '餐廳', '吃', '喝', '餐', '飯'],
                '交通': ['交通', '計程車', '加油', '油錢', '交通費', '搭車', '車', '捷運', '公車'],
                '娛樂': ['娛樂', '看電影', '唱歌', '遊戲', 'KTV', '電影院', '玩'],
                '購物': ['購物', '買衣服', '買鞋子', '買東西', '百貨', '商場', '網購', '買'],
                '生活': ['生活', '水費', '電費', '瓦斯費', '房租', '生活用品', '繳費', '日用品'],
                '其他': ['其他', '雜項', '其他費用', '捐款']
            };

            const sortedKeywords = [];
            for (const categoryName in categoryKeywords) {
                categoryKeywords[categoryName].forEach(keyword => {
                    sortedKeywords.push({ category: categoryName, keyword: keyword });
                });
            }
            sortedKeywords.sort((a, b) => b.keyword.length - a.keyword.length);

            for (const item of sortedKeywords) {
                if (speechResult.includes(item.keyword)) {
                    parsedCategory = item.category;
                    parsedTitle = parsedTitle.replace(new RegExp(item.keyword + '\\s*', 'g'), '').trim();
                    break;
                }
            }

            titleInput.value = parsedTitle || speechResult;
            amountInput.value = parsedAmount !== null ? parsedAmount : '';
            categorySelect.value = (parsedCategory && availableCategories.includes(parsedCategory)) ? parsedCategory : '';
            dateInput.value = parsedDate || formatDate(today);

            if (parsedTitle) titleInput.classList.add('input-highlight');
            if (parsedAmount !== null) amountInput.classList.add('input-highlight');
            if (parsedCategory) categorySelect.classList.add('input-highlight');
            if (parsedDate) dateInput.classList.add('input-highlight');

            setTimeout(() => {
                titleInput.classList.remove('input-highlight');
                amountInput.classList.remove('input-highlight');
                categorySelect.classList.remove('input-highlight');
                dateInput.classList.remove('input-highlight');
            }, 1600);

            let warnings = [];
            if (parsedAmount === null) warnings.push('金額');
            if (!parsedCategory || !availableCategories.includes(parsedCategory)) warnings.push('分類');
            if (!parsedDate) warnings.push('日期（已預設為今天）');

            if (warnings.length > 0) {
                showMessage('message', `語音解析完成，但以下資訊可能不完整或已預設：${warnings.join('、')}。請檢查並補齊資訊。`, 'warning');
            } else {
                showMessage('message', '語音解析成功，請確認資訊後提交。', 'success');
            }
        }

        // --- CSV 匯入相關的 JavaScript 邏輯 ---
        let parsedCsvData = [];

        async function processCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('importMessage', '請選擇一個 CSV 檔案。', 'warning');
                return;
            }

            toggleLoading('importLoading', true);
            toggleButtonDisabled('processCsvButton', true);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').map(line => line.trim()).filter(Boolean);

                    if (lines.length < 1) {
                        showMessage('importMessage', 'CSV 檔案內容為空。', 'error');
                        return;
                    }

                    const [headerLine, ...dataLines] = lines;
                    const headers = headerLine.split(',').map(h => h.trim());
                    const mapping = guessColumnMapping(headers);

                    if (
                        mapping.title === undefined ||
                        mapping.amount === undefined ||
                        mapping.category === undefined ||
                        mapping.date === undefined
                    ) {
                        showMessage('importMessage', 'CSV 檔案缺少必要的欄位（標題、金額、分類、日期）。', 'error');
                        return;
                    }

                    parsedCsvData = dataLines.map(line => {
                        const cols = line.split(',').map(c => c.trim());
                        const rawDate = cols[mapping.date];
                        let formattedDate = null;
                        if (rawDate) {
                            const dateObj = new Date(rawDate);
                            if (!isNaN(dateObj) && dateObj.getFullYear() > 1900) {
                                formattedDate = dateObj.toISOString().split('T')[0];
                            }
                        }

                        return {
                            title: cols[mapping.title] || '',
                            amount: parseFloat(cols[mapping.amount]) || 0,
                            category: cols[mapping.category] || '其他',
                            date: formattedDate
                        };
                    }).filter(data => data.date !== null);

                    displayCsvPreview(headers, parsedCsvData.slice(0, 5), mapping);
                    document.getElementById('confirm-import').style.display = 'block';
                    document.getElementById('preview-area').style.display = 'block';
                    showMessage('importMessage', `已成功解析 ${parsedCsvData.length} 筆資料。請確認後匯入。`, 'info');

                } catch (error) {
                    console.error('解析 CSV 失敗:', error);
                    showMessage('importMessage', `解析 CSV 失敗: ${error.message}。請檢查檔案格式。`, 'error');
                } finally {
                    toggleLoading('importLoading', false);
                    toggleButtonDisabled('processCsvButton', false);
                }
            };
            reader.readAsText(file);
        }

        function displayCsvPreview(headers, data, mapping) {
            const previewTableHead = document.querySelector('#csvPreviewTable thead tr');
            const previewTableBody = document.querySelector('#csvPreviewTable tbody');
            previewTableHead.innerHTML = '';
            previewTableBody.innerHTML = '';

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                previewTableHead.appendChild(th);
            });

            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((header, index) => {
                    const td = document.createElement('td');
                    let cellText = '';
                    let isMapped = false;
                    if (mapping.title === index) { cellText = row.title; isMapped = true; }
                    else if (mapping.amount === index) { cellText = row.amount.toFixed(2); isMapped = true; }
                    else if (mapping.category === index) { cellText = row.category; isMapped = true; }
                    else if (mapping.date === index) { cellText = row.date; isMapped = true; }
                    else {
                        cellText = "N/A";
                    }
                    td.textContent = cellText;
                    if (isMapped) {
                        td.style.backgroundColor = 'rgba(144, 238, 144, 0.3)';
                    }
                    tr.appendChild(td);
                });
                tr.addEventListener('click', () => {
                    console.log('Clicked row data:', row);
                });
                previewTableBody.appendChild(tr);
            });
        }

        // 自動欄位對應函式
        function guessColumnMapping(headerRow) {
            const mapping = {};
            headerRow.forEach((col, idx) => {
                const key = col.trim().toLowerCase();

                if (key.includes("id")) {
                    mapping.id = idx;
                }

                if (key.includes("金額") || key.includes("amount") || key.includes("總計")) {
                    mapping.amount = idx;
                } else if (
                    key.includes("日期") || key.includes("date") ||
                    key.includes("記帳") || key.includes("時間")
                ) {
                    if (!mapping.date) mapping.date = idx;
                } else if (
                    key.includes("標題") || key.includes("title") ||
                    key.includes("備註") || key.includes("說明") || key.includes("內容")
                ) {
                    mapping.title = idx;
                } else if (
                    key.includes("分類") || key.includes("category") || key.includes("類別")
                ) {
                    if (mapping.category === undefined) mapping.category = idx;
                    else if (mapping.subcategory === undefined) mapping.subcategory = idx;
                }
            });
            return mapping;
        }

        async function confirmImport() {
            if (parsedCsvData.length === 0) {
                showMessage('importMessage', '沒有要匯入的資料。請先選擇並解析 CSV 檔案。', 'warning');
                return;
            }

            toggleLoading('importLoading', true);
            toggleButtonDisabled('confirm-import', true);

            let existingExpenses = [];
            try {
                const res = await fetch("/api/expenses");
                existingExpenses = await res.json();
            } catch (err) {
                showMessage('importMessage', '無法取得現有資料，請檢查後端服務！', 'error');
                toggleLoading('importLoading', false);
                toggleButtonDisabled('confirm-import', false);
                return;
            }

            const newExpensesToImport = parsedCsvData.filter(exp => {
                return !existingExpenses.some(e =>
                    e.title === exp.title &&
                    parseFloat(e.amount) === exp.amount &&
                    e.category === exp.category &&
                    e.date === exp.date
                );
            });

            if (newExpensesToImport.length === 0) {
                showMessage('importMessage', "所有資料都已存在，沒有需要匯入的新資料！", 'info');
                toggleLoading('importLoading', false);
                toggleButtonDisabled('confirm-import', false);
                return;
            }

            let successCount = 0;
            let failCount = 0;
            for (const exp of newExpensesToImport) {
                if (!exp.title || isNaN(exp.amount) || !exp.category || !exp.date) {
                    console.warn("跳過無效的匯入資料:", exp);
                    failCount++;
                    continue;
                }

                try {
                    const res = await fetch("/api/expenses", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(exp)
                    });

                    if (res.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error("匯入單筆失敗：", exp, await res.text());
                    }
                } catch (err) {
                    failCount++;
                    console.error("匯入單筆失敗（網路錯誤）：", exp, err);
                }
            }

            showMessage('importMessage', `匯入完成！成功 ${successCount} 筆，失敗 ${failCount} 筆。（已自動略過重複資料）`, successCount > 0 ? 'success' : 'warning');

            document.getElementById('csvFileInput').value = '';
            document.getElementById('processCsvButton').style.display = 'none';
            document.getElementById('confirm-import').style.display = 'none';
            document.getElementById('preview-area').style.display = 'none';
            parsedCsvData = [];

            queryExpenses();
            loadCategoryBudgets();
            loadMonthlyStatistics();

            toggleLoading('importLoading', false);
            toggleButtonDisabled('confirm-import', false);
        }

        // 匯出 CSV 功能
        function exportVisibleTableToCSV() {
            const rows = [];
            const headers = ["ID", "標題", "金額", "分類", "日期"];
            rows.push(headers);

            const tableRows = document.querySelectorAll("#expenseTableBody tr");
            tableRows.forEach(tr => {
                const cells = Array.from(tr.querySelectorAll("td")).slice(0, 5).map(td => td.textContent.trim());
                rows.push(cells);
            });

            const csvContent = rows.map(row => row.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "支出紀錄.csv");
            link.click();
        }


        // --- DOMContentLoaded 監聽器 (頁面載入完成後執行) ---
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化新增支出表單的日期為今天
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            // 設置預算和統計區塊的預設年份和月份為當前時間
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            document.getElementById('cbYear').value = currentYear;
            document.getElementById('cbMonth').value = currentMonth;
            document.getElementById('statYear').value = currentYear;
            document.getElementById('statMonth').value = currentMonth;

            // 綁定事件監聽器
            document.getElementById('expenseForm').addEventListener('submit', addExpenseHandler);
            document.getElementById('categoryBudgetForm').addEventListener('submit', categoryBudgetHandler);
            document.getElementById('editForm').addEventListener('submit', editFormHandler);
            document.getElementById('loadStatsButton').addEventListener('click', loadMonthlyStatistics);
            document.getElementById('queryExpensesButton').addEventListener('click', queryExpenses);
            document.getElementById('resetExpensesButton').addEventListener('click', resetExpenses);
            document.getElementById('processCsvButton').addEventListener('click', processCSV);
            document.getElementById('confirm-import').addEventListener('click', confirmImport);
            document.getElementById('csvFileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('processCsvButton').style.display = 'block';
                    document.getElementById('confirm-import').style.display = 'none';
                    document.getElementById('preview-area').style.display = 'none';
                    showMessage('importMessage', '', '');
                } else {
                    document.getElementById('processCsvButton').style.display = 'none';
                }
            });


            // --- 主題切換邏輯 ---
            const toggleButton = document.getElementById("toggle-theme");

            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                toggleButton.innerText = "🌙 深色模式";
            } else {
                document.body.classList.remove("dark-mode");
                toggleButton.innerText = "☀️ 淺色模式";
            }

            toggleButton.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");

                if (document.body.classList.contains("dark-mode")) {
                    toggleButton.innerText = "🌙 深色模式";
                } else {
                    toggleButton.innerText = "☀️ 淺色模式";
                }

                localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");

                if (document.getElementById('statistics-page').style.display !== 'none') {
                     loadMonthlyStatistics();
                }
            });

            // 為導覽列連結添加事件監聽器
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageId = event.target.closest('.nav-link').dataset.page;
                    showPage(pageId);
                });
            });

            // 初始化語音輸入按鈕狀態
            const speechInputButton = document.getElementById('speechInputButton');
            const stopSpeechInputButton = document.getElementById('stopSpeechInputButton');
            const speechLoading = document.getElementById('speechLoading');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                speechInputButton.style.display = 'none';
                stopSpeechInputButton.style.display = 'none';
                showMessage('message', '抱歉，您的瀏覽器不支持麥克風錄音功能。請使用 Chrome 或其他兼容瀏覽器。', 'error');
            }

            let streamRef = null;

            speechInputButton.addEventListener('click', async () => {
                try {
                    streamRef = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(streamRef, { mimeType: 'audio/webm; codecs=opus' });

                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        toggleLoading('speechLoading', true);
                        showMessage('message', '語音錄製完成，正在識別中...', 'info');

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                        await sendAudioForTranscription(audioBlob);

                        if (streamRef) {
                            streamRef.getTracks().forEach(track => track.stop());
                        }
                        speechInputButton.style.display = 'block';
                        stopSpeechInputButton.style.display = 'none';
                        speechInputButton.classList.remove('recording');
                        toggleLoading('speechLoading', false);
                    };

                    mediaRecorder.start();
                    showMessage('message', '請開始說話... (點擊「停止語音輸入」按鈕結束)', 'info');
                    speechInputButton.style.display = 'none';
                    stopSpeechInputButton.style.display = 'block';
                    speechInputButton.classList.add('recording');

                } catch (err) {
                    console.error('無法取得麥克風權限:', err);
                    showMessage('message', '無法取得麥克風權限，請允許瀏覽器使用麥克風。', 'error');
                    speechInputButton.classList.remove('recording');
                    toggleLoading('speechLoading', false);
                }
            });

            stopSpeechInputButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            });

            // 預設顯示第一個頁面
            showPage('add-expense-page');
        });
    </script>
</body>
</html>