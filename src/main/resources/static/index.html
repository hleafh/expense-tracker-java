<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ç°¡æ˜“è¨˜å¸³ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="header">
        <h1>è¨˜å¸³ç³»çµ±</h1>
        <button id="toggle-theme">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
    </header>

    <div class="main-layout">
        <nav class="sidebar">
            <h2>åŠŸèƒ½é¸å–®</h2>
            <ul>
                <li><a href="#" data-page="add-expense-page" class="nav-link active">
                    <i class="fas fa-plus-circle"></i> æ–°å¢æ”¯å‡º
                </a></li>
                <li><a href="#" data-page="category-budget-page" class="nav-link">
                    <i class="fas fa-wallet"></i> åˆ†é¡é ç®—
                </a></li>
                <li><a href="#" data-page="statistics-page" class="nav-link">
                    <i class="fas fa-chart-pie"></i> çµ±è¨ˆå ±è¡¨
                </a></li>
                <li><a href="#" data-page="expense-records-page" class="nav-link">
                    <i class="fas fa-list-alt"></i> æ”¯å‡ºç´€éŒ„
                </a></li>
                <li><a href="#" data-page="data-management-page" class="nav-link">
                    <i class="fas fa-file-import"></i> è³‡æ–™ç®¡ç†
                </a></li>
            </ul>
        </nav>

        <main class="content-area">
            <div id="add-expense-page" class="page active">
                <div class="container">
                    <form id="expenseForm">
                        <h2>æ–°å¢æ”¯å‡º</h2>
                        <label for="title">æ¨™é¡Œï¼š</label>
                        <input type="text" id="title" required>
                        <label for="amount">é‡‘é¡ï¼š</label>
                        <input type="number" id="amount" step="0.01" required>
                        <label for="category">åˆ†é¡ï¼š</label>
                        <select id="category" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option>é¤é£²</option>
                            <option>äº¤é€š</option>
                            <option>å¨›æ¨‚</option>
                            <option>è³¼ç‰©</option>
                            <option>ç”Ÿæ´»</option>
                            <option>å…¶ä»–</option>
                        </select>
                        <label for="date">æ—¥æœŸï¼š</label>
                        <input type="date" id="date" required>

                        <button type="button" class="speech-button" id="speechInputButton">
                            <i class="fas fa-microphone"></i> é–‹å§‹èªéŸ³è¼¸å…¥
                        </button>
                        <button type="button" class="speech-button recording" id="stopSpeechInputButton" style="display: none;">
                            <i class="fas fa-microphone-slash"></i> åœæ­¢èªéŸ³è¼¸å…¥
                        </button>
                        <div id="speechLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> èªéŸ³è™•ç†ä¸­...
                        </div>

                        <button type="submit" id="addExpenseButton">æ–°å¢æ”¯å‡º</button>
                        <div id="message" class="message"></div>
                        <div id="expenseFormLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...
                        </div>
                    </form>
                </div>
            </div>

            <div id="category-budget-page" class="page" style="display: none;">
                <div class="container">
                    <h2>è¨­å®šåˆ†é¡é ç®—</h2>
                    <form id="categoryBudgetForm">
                        <label for="cbYear">å¹´ä»½ï¼š</label>
                        <input type="number" id="cbYear" min="2000" max="2100" required>
                        <label for="cbMonth">æœˆä»½ï¼š</label>
                        <input type="number" id="cbMonth" min="1" max="12" required>
                        <label for="cbCategory">åˆ†é¡ï¼š</label>
                        <select id="cbCategory" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option>é¤é£²</option>
                            <option>äº¤é€š</option>
                            <option>å¨›æ¨‚</option>
                            <option>è³¼ç‰©</option>
                            <option>ç”Ÿæ´»</option>
                            <option>å…¶ä»–</option>
                        </select>
                        <label for="cbAmount">é ç®—é‡‘é¡ï¼š</label>
                        <input type="number" id="cbAmount" step="0.01" min="0" required>
                        <button type="submit" id="saveBudgetButton">å„²å­˜åˆ†é¡é ç®—</button>
                        <div id="categoryBudgetMessage" class="message"></div>
                        <div id="budgetFormLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...
                        </div>
                    </form>
                    <h3>ç•¶æœˆåˆ†é¡é ç®—æ¦‚è¦½ï¼š</h3>
                    <p>ç¸½é ç®—ï¼š<span id="totalMonthlyBudget">--</span></p>
                    <table id="categoryBudgetTable">
                        <thead>
                            <tr>
                                <th>åˆ†é¡</th>
                                <th>é ç®—é‡‘é¡</th>
                            </tr>
                        </thead>
                        <tbody id="categoryBudgetTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="statistics-page" class="page" style="display: none;">
                <div class="container">
                    <h2>æ¯æœˆåˆ†é¡æ”¯å‡ºçµ±è¨ˆ</h2>
                    <div>
                        <label for="statYear">å¹´ä»½ï¼š</label>
                        <input type="number" id="statYear" min="2000" max="2100">
                        <label for="statMonth">æœˆä»½ï¼š</label>
                        <input type="number" id="statMonth" min="1" max="12">
                        <button id="loadStatsButton">æŸ¥çœ‹çµ±è¨ˆ</button>
                        <div id="statsLoading" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...
                        </div>
                    </div>

                    <h3>åˆ†é¡æ”¯å‡ºæ˜ç´°ï¼š</h3>
                    <table id="monthlyStatTable">
                        <thead>
                            <tr>
                                <th>åˆ†é¡</th>
                                <th>ç¸½é‡‘é¡</th>
                                <th>é ç®—é‡‘é¡</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyStatTableBody">
                        </tbody>
                    </table>

                    <h3>æ”¯å‡ºåˆ†ä½ˆåœ“é¤…åœ–ï¼š</h3>
                    <div style="width: 70%; margin: 20px auto;">
                        <canvas id="expensePieChart"></canvas>
                    </div>

                    <h3>é ç®—å°æ¯”ç›´æ¢åœ–ï¼š</h3>
                    <div style="width: 70%; margin: 20px auto;">
                        <canvas id="budgetComparisonChart"></canvas>
                    </div>

                    <div id="monthlyStatMessage" class="message"></div>
                </div>
            </div>

            <div id="expense-records-page" class="page" style="display: none;">
                <div class="container">
                    <h2>æ”¯å‡ºç´€éŒ„</h2>
                    <div style="margin-bottom: 20px;">
                        <label>é–‹å§‹æ—¥æœŸï¼š</label>
                        <input type="date" id="startDate">
                        <label>çµæŸæ—¥æœŸï¼š</label>
                        <input type="date" id="endDate">
                        <button id="queryExpensesButton">æŸ¥è©¢</button>
                        <button id="resetExpensesButton">é‡ç½®</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>æ¨™é¡Œ</th>
                                <th>é‡‘é¡</th>
                                <th>åˆ†é¡</th>
                                <th>æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="data-management-page" class="page" style="display: none;">
                <div class="container">
                    <h2>CSV åŒ¯å…¥</h2>
                    <input type="file" accept=".csv" id="csvFileInput">
                    <button id="processCsvButton" style="display: none;">è§£æä¸¦é è¦½</button>

                    <div id="preview-area" style="margin-top: 1em; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; display: none;">
                        <h4>åŒ¯å…¥é è¦½ (å‰5è¡Œ)</h4>
                        <table id="csvPreviewTable" style="width:100%;">
                            <thead><tr></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button id="confirm-import" style="display: none;">é–‹å§‹åŒ¯å…¥</button>
                    <div id="importMessage" class="message"></div>
                    <div id="importLoading" class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> åŒ¯å…¥ä¸­...
                    </div>
                </div>

                <div class="container" style="margin-top: 30px;">
                    <h3>åŒ¯å‡ºè³‡æ–™</h3>
                    <button onclick="exportVisibleTableToCSV()">åŒ¯å‡º CSV</button>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2>ç·¨è¼¯æ”¯å‡º</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <label>æ¨™é¡Œï¼š</label><input type="text" id="editTitle" required>
                <label>é‡‘é¡ï¼š</label><input type="number" id="editAmount" step="0.01" required>
                <label>åˆ†é¡ï¼š</label>
                <select id="editCategory" required>
                    <option>é¤é£²</option><option>äº¤é€š</option><option>å¨›æ¨‚</option>
                    <option>è³¼ç‰©</option><option>ç”Ÿæ´»</option><option>å…¶ä»–</option>
                </select>
                <label>æ—¥æœŸï¼š</label><input type="date" id="editDate" required>
                <button type="submit" id="saveEditButton">å„²å­˜ä¿®æ”¹</button>
                <div id="editFormLoading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- API URL å®šç¾© ---
        const expenseApiUrl = '/api/expenses';
        const categoryBudgetApiUrl = '/api/category-budgets';
        const statisticsApiUrl = '/api/expenses/statistics';
        const transcribeApiUrl = '/api/speech/transcribe';

        // --- Chart.js å¯¦ä¾‹ ---
        let expensePieChartInstance = null;
        let budgetComparisonChartInstance = null;

        // --- MediaRecorder ç›¸é—œè®Šæ•¸ ---
        let mediaRecorder;
        let audioChunks = [];

        // --- è¼”åŠ©å‡½æ•¸ ---

        /**
         * é¡¯ç¤ºè¨Šæ¯æç¤º
         * @param {string} elementId - é¡¯ç¤ºè¨Šæ¯çš„ DOM å…ƒç´  ID
         * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯å…§å®¹
         * @param {string} type - è¨Šæ¯é¡å‹ ('success', 'error', 'warning', 'info')
         * @param {number} duration - è¨Šæ¯é¡¯ç¤ºçš„æ™‚é–“ (æ¯«ç§’)ï¼Œé è¨­ 3000ms
         */
        function showMessage(elementId, message, type, duration = 3000) {
            const msgElement = document.getElementById(elementId);
            if (!msgElement) return;

            msgElement.textContent = message;
            msgElement.className = `message ${type}`;
            clearTimeout(msgElement.timer);
            msgElement.timer = setTimeout(() => {
                msgElement.textContent = '';
                msgElement.className = 'message';
            }, duration);
        }

        /**
         * é¡¯ç¤º/éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
         * @param {string} elementId - è¼‰å…¥æŒ‡ç¤ºå™¨ DOM å…ƒç´  ID
         * @param {boolean} show - æ˜¯å¦é¡¯ç¤º
         */
        function toggleLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        /**
         * å•Ÿç”¨/ç¦ç”¨æŒ‰éˆ•ä¸¦æ›´æ–°æ–‡å­—
         * @param {string} buttonId - æŒ‰éˆ• DOM å…ƒç´  ID
         * @param {boolean} disabled - æ˜¯å¦ç¦ç”¨
         */
        function toggleButtonDisabled(buttonId, disabled) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (!button.getAttribute('data-original-text')) {
                    button.setAttribute('data-original-text', button.textContent);
                }
                button.disabled = disabled;
                button.textContent = disabled ? 'è™•ç†ä¸­...' : button.getAttribute('data-original-text');
            }
        }

        /**
         * å°‡ Date ç‰©ä»¶æ ¼å¼åŒ–ç‚ºYYYY-MM-DD å­—ç¬¦ä¸²ï¼Œä¸¦è™•ç†æ™‚å€å•é¡Œ
         * @param {Date} dateObj - Date ç‰©ä»¶
         * @returns {string} æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸå­—ç¬¦ä¸²
         */
        const formatDate = (dateObj) => {
            const year = dateObj.getUTCFullYear();
            const month = (dateObj.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getUTCDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        // é é¢åˆ‡æ›å‡½æ•¸
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            const currentPageElement = document.getElementById(pageId);
            if (currentPageElement) {
                currentPageElement.style.display = 'block';
            }

            // æ›´æ–°å°è¦½åˆ—çš„ active ç‹€æ…‹
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // åªæœ‰å¸¸è¦å°è¦½é …ç›®æ‰æ·»åŠ  active class
            const activeNavLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
            }


            // æ ¹æ“šåˆ‡æ›åˆ°çš„é é¢åŸ·è¡Œæ•¸æ“šè¼‰å…¥
            switch (pageId) {
                case 'expense-records-page':
                    queryExpenses(); // è¼‰å…¥æ”¯å‡ºç´€éŒ„
                    break;
                case 'category-budget-page':
                    loadCategoryBudgets(); // è¼‰å…¥åˆ†é¡é ç®—
                    break;
                case 'statistics-page':
                    loadMonthlyStatistics(); // è¼‰å…¥æ¯æœˆçµ±è¨ˆ
                    break;
                case 'add-expense-page':
                    // Reset date to today when entering Add Expense page
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    break;
                case 'data-management-page':
                    // Clear previous CSV state if any
                    const csvFileInput = document.getElementById('csvFileInput');
                    if (csvFileInput) csvFileInput.value = ''; // Clear selected file
                    document.getElementById('processCsvButton').style.display = 'none';
                    document.getElementById('confirm-import').style.display = 'none';
                    document.getElementById('preview-area').style.display = 'none';
                    showMessage('importMessage', '', ''); // Clear import messages
                    break;
                // 'edit-expense-page' ä¸å†æ˜¯å°è¦½åˆ—å¯ç›´æ¥é€²å…¥çš„é é¢
                // è€Œæ˜¯ç”± 'expense-records-page' ä¸­çš„æŒ‰éˆ•ç›´æ¥è§¸ç™¼å½ˆçª—
            }
        }

        // æ–°å¢æ”¯å‡ºè¡¨å–®æäº¤è™•ç†
        async function addExpenseHandler(e) {
            e.preventDefault();
            toggleLoading('expenseFormLoading', true);
            toggleButtonDisabled('addExpenseButton', true);

            const data = {
                title: document.getElementById('title').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };
            try {
                const res = await fetch(expenseApiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();

                if (res.ok) {
                    if (responseData.overbudget) {
                        showMessage('message', responseData.message + ' æ‚¨å¯ä»¥è€ƒæ…®èª¿æ•´å…¶ä»–é ç®—æˆ–æ”¯å‡ºã€‚', 'warning');
                    } else {
                        showMessage('message', responseData.message || 'æ–°å¢æˆåŠŸ', 'success');
                    }
                    document.getElementById('expenseForm').reset();
                    document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Reset date to today
                    queryExpenses(); // Refresh expense records
                    loadCategoryBudgets(); // Refresh budgets display
                    loadMonthlyStatistics(); // Refresh statistics
                } else {
                    showMessage('message', responseData.message || 'æ–°å¢å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('æ–°å¢æ”¯å‡ºå¤±æ•—:', error);
                showMessage('message', 'æ–°å¢æ”¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯æœå‹™ã€‚', 'error');
            } finally {
                toggleLoading('expenseFormLoading', false);
                toggleButtonDisabled('addExpenseButton', false);
            }
        }

        // åˆ†é¡é ç®—è¡¨å–®æäº¤è™•ç†
        async function categoryBudgetHandler(e) {
            e.preventDefault();
            toggleLoading('budgetFormLoading', true);
            toggleButtonDisabled('saveBudgetButton', true);

            const data = {
                year: parseInt(document.getElementById('cbYear').value),
                month: parseInt(document.getElementById('cbMonth').value),
                category: document.getElementById('cbCategory').value,
                amount: parseFloat(document.getElementById('cbAmount').value)
            };
            try {
                const res = await fetch(categoryBudgetApiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();
                if (res.ok) {
                    showMessage('categoryBudgetMessage', 'åˆ†é¡é ç®—å„²å­˜æˆåŠŸ', 'success');
                    loadCategoryBudgets();
                    loadMonthlyStatistics();
                } else {
                    showMessage('categoryBudgetMessage', responseData.message || 'åˆ†é¡é ç®—å„²å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('å„²å­˜åˆ†é¡é ç®—å¤±æ•—:', error);
                showMessage('categoryBudgetMessage', 'å„²å­˜åˆ†é¡é ç®—å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯æœå‹™ã€‚', 'error');
            } finally {
                toggleLoading('budgetFormLoading', false);
                toggleButtonDisabled('saveBudgetButton', false);
            }
        }

        // è¼‰å…¥åˆ†é¡é ç®—æ¦‚è¦½å’Œç¸½é ç®—
        async function loadCategoryBudgets() {
            const year = parseInt(document.getElementById('cbYear').value);
            const month = parseInt(document.getElementById('cbMonth').value);

            try {
                const categoryRes = await fetch(`${categoryBudgetApiUrl}/${year}/${month}`);
                if (!categoryRes.ok) throw new Error('Failed to load category budgets');
                const categoryBudgets = await categoryRes.json();
                const categoryBudgetTableBody = document.getElementById('categoryBudgetTableBody');
                categoryBudgetTableBody.innerHTML = '';
                if (categoryBudgets.length === 0) {
                    categoryBudgetTableBody.innerHTML = '<tr><td colspan="2">æœ¬æœˆå°šç„¡åˆ†é¡é ç®—ã€‚</td></tr>';
                } else {
                    categoryBudgets.forEach(cb => {
                        categoryBudgetTableBody.innerHTML += `
                            <tr>
                                <td>${cb.category}</td>
                                <td>${cb.amount.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡é ç®—å¤±æ•—:', error);
                showMessage('categoryBudgetMessage', 'è¼‰å…¥åˆ†é¡é ç®—å¤±æ•—', 'error');
            }

            try {
                const totalBudgetRes = await fetch(`${categoryBudgetApiUrl}/total/${year}/${month}`);
                if (!totalBudgetRes.ok) throw new Error('Failed to load total budget');
                const totalBudgetData = await totalBudgetRes.json();
                document.getElementById('totalMonthlyBudget').textContent = totalBudgetData.totalBudget.toFixed(2) || '0.00';
            } catch (error) {
                console.error('è¼‰å…¥ç¸½é ç®—å¤±æ•—:', error);
                document.getElementById('totalMonthlyBudget').textContent = '--';
            }
        }

        // åˆªé™¤æ”¯å‡ºç´€éŒ„
        async function deleteExpense(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†æ”¯å‡ºç´€éŒ„å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${expenseApiUrl}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    // ä½¿ç”¨æ–°å¢æ”¯å‡ºé é¢çš„è¨Šæ¯æ¡†ä¾†é¡¯ç¤ºåˆªé™¤æˆåŠŸè¨Šæ¯
                    showMessage('message', 'æ”¯å‡ºå·²æˆåŠŸåˆªé™¤', 'success');
                    queryExpenses(); // Refresh expense records
                    loadCategoryBudgets(); // Refresh budgets display
                    loadMonthlyStatistics(); // Refresh statistics
                } else {
                    const errorBody = await res.json();
                    showMessage('message', errorBody.message || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                showMessage('message', 'åˆªé™¤æ”¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯æœå‹™ã€‚', 'error');
            }
        }

        // é–‹å•Ÿç·¨è¼¯å½ˆçª—ä¸¦è¼‰å…¥æ•¸æ“š
        function openEditModal(id) {
            fetch(`${expenseApiUrl}/${id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('editId').value = data.id;
                    document.getElementById('editTitle').value = data.title;
                    document.getElementById('editAmount').value = data.amount;
                    document.getElementById('editCategory').value = data.category;
                    document.getElementById('editDate').value = data.date;
                    document.getElementById('editModal').style.display = 'block'; // é¡¯ç¤ºå½ˆçª—
                })
                .catch(error => {
                    console.error('è¼‰å…¥ç·¨è¼¯è³‡æ–™å¤±æ•—:', error);
                    showMessage('message', 'ç„¡æ³•è¼‰å…¥æ”¯å‡ºè³‡æ–™é€²è¡Œç·¨è¼¯ã€‚', 'error'); // ä½¿ç”¨æ–°å¢æ”¯å‡ºé é¢çš„è¨Šæ¯æ¡†
                });
        }

        // é—œé–‰ç·¨è¼¯å½ˆçª—
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none'; // éš±è—å½ˆçª—
        }

        // ç·¨è¼¯è¡¨å–®æäº¤è™•ç†
        async function editFormHandler(e) {
            e.preventDefault();
            toggleLoading('editFormLoading', true);
            toggleButtonDisabled('saveEditButton', true);

            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                category: document.getElementById('editCategory').value,
                date: document.getElementById('editDate').value
            };
            try {
                const res = await fetch(`${expenseApiUrl}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const responseData = await res.json();
                closeEditModal(); // ä¸è«–æˆåŠŸæˆ–å¤±æ•—éƒ½é—œé–‰ç·¨è¼¯è¦–çª—

                if (res.ok) {
                    // ä½¿ç”¨æ–°å¢æ”¯å‡ºé é¢çš„è¨Šæ¯æ¡†ä¾†é¡¯ç¤ºæ›´æ–°æˆåŠŸè¨Šæ¯
                    if (responseData.overbudget) {
                        showMessage('message', responseData.message + ' æ‚¨å¯ä»¥è€ƒæ…®èª¿æ•´å…¶ä»–é ç®—æˆ–æ”¯å‡ºã€‚', 'warning');
                    } else {
                        showMessage('message', responseData.message || 'æ”¯å‡ºå·²æ›´æ–°', 'success');
                    }
                    queryExpenses();
                    loadCategoryBudgets();
                    loadMonthlyStatistics();
                } else {
                    // ä½¿ç”¨æ–°å¢æ”¯å‡ºé é¢çš„è¨Šæ¯æ¡†ä¾†é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    showMessage('message', responseData.message || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±æ•—:', error);
                showMessage('message', 'æ›´æ–°æ”¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯æœå‹™ã€‚', 'error');
            } finally {
                toggleLoading('editFormLoading', false);
                toggleButtonDisabled('saveEditButton', false);
            }
        }

        // åŸ·è¡Œæ—¥æœŸå€é–“æŸ¥è©¢
        async function queryExpenses() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let url = '/api/expenses';
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();
                updateExpenseTable(data);
            } catch (error) {
                console.error('æŸ¥è©¢å¤±æ•—', error);
                // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦åœ¨æ”¯å‡ºç´€éŒ„é é¢é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                // ä¾‹å¦‚: showMessage('expenseRecordsMessage', 'è¼‰å…¥æ”¯å‡ºç´€éŒ„å¤±æ•—', 'error');
            }
        }

        // é‡ç½®æ—¥æœŸæŸ¥è©¢æ¢ä»¶ä¸¦é‡æ–°è¼‰å…¥æ‰€æœ‰æ”¯å‡º
        function resetExpenses() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            queryExpenses();
        }

        // æ›´æ–°æ”¯å‡ºè¡¨æ ¼å…§å®¹
        function updateExpenseTable(expenses) {
            const tableBody = document.getElementById('expenseTableBody');
            tableBody.innerHTML = '';

            if (expenses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ”¯å‡ºç´€éŒ„ã€‚</td></tr>';
                return;
            }

            expenses.forEach(expense => {
                const row = document.createElement('tr');
                // æ³¨æ„ï¼šé€™è£¡ç›´æ¥å‘¼å« openEditModal(id)
                row.innerHTML = `
                    <td>${expense.id}</td>
                    <td>${expense.title}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td>${expense.category}</td>
                    <td>${expense.date}</td>
                    <td>
                        <button class="action-button edit" onclick="openEditModal(${expense.id})">ç·¨è¼¯</button>
                        <button class="action-button delete" onclick="deleteExpense(${expense.id})">åˆªé™¤</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // è¼‰å…¥æ¯æœˆæ”¯å‡ºçµ±è¨ˆæ•¸æ“š
        async function loadMonthlyStatistics() {
            const year = document.getElementById('statYear').value;
            const month = document.getElementById('statMonth').value;
            const msg = document.getElementById('monthlyStatMessage');
            msg.textContent = '';
            toggleLoading('statsLoading', true);
            toggleButtonDisabled('loadStatsButton', true);

            if (!year || !month) {
                showMessage('monthlyStatMessage', 'è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½ã€‚', 'error');
                toggleLoading('statsLoading', false);
                toggleButtonDisabled('loadStatsButton', false);
                return;
            }

            try {
                const res = await fetch(`${statisticsApiUrl}/${year}/${month}`);
                if (!res.ok) {
                    throw new Error('ç„¡æ³•ç²å–æ¯æœˆçµ±è¨ˆæ•¸æ“šã€‚');
                }
                const data = await res.json();
                console.log('æ¯æœˆåˆ†é¡çµ±è¨ˆæ•¸æ“š (åŒ…å«é ç®—):', data);

                updateMonthlyStatTable(data);
                renderExpensePieChart(data);
                renderBudgetComparisonChart(data);
                showMessage('monthlyStatMessage', 'æ¯æœˆçµ±è¨ˆæ•¸æ“šå·²æ›´æ–°ã€‚', 'success');

            } catch (error) {
                console.error('è¼‰å…¥æ¯æœˆçµ±è¨ˆå¤±æ•—:', error);
                showMessage('monthlyStatMessage', `è¼‰å…¥æ¯æœˆçµ±è¨ˆå¤±æ•—ï¼š${error.message}`, 'error');
                updateMonthlyStatTable([]);
                renderExpensePieChart([]);
                renderBudgetComparisonChart([]);
            } finally {
                toggleLoading('statsLoading', false);
                toggleButtonDisabled('loadStatsButton', false);
            }
        }

        // æ›´æ–°æ¯æœˆçµ±è¨ˆè¡¨æ ¼
        function updateMonthlyStatTable(statistics) {
            const tbody = document.getElementById('monthlyStatTableBody');
            tbody.innerHTML = '';

            if (statistics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">æœ¬æœˆå°šç„¡æ”¯å‡ºç´€éŒ„ã€‚</td></tr>';
                return;
            }

            statistics.forEach(item => {
                const isOverbudget = (item.budgetAmount > 0 && item.totalAmount > item.budgetAmount);
                const statusText = isOverbudget ? 'è¶…å‡ºé ç®—' : (item.budgetAmount > 0 ? 'é ç®—å…§' : 'ç„¡é ç®—');
                const rowClass = isOverbudget ? 'overbudget-row' : '';
                const totalAmountClass = isOverbudget ? 'overbudget-text' : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${item.category}</td>
                        <td class="${totalAmountClass}">${item.totalAmount.toFixed(2)}</td>
                        <td>${item.budgetAmount.toFixed(2)}</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });
        }

        // ç¹ªè£½åœ“é¤…åœ–
        function renderExpensePieChart(statistics) {
            const ctx = document.getElementById('expensePieChart').getContext('2d');

            if (expensePieChartInstance) {
                expensePieChartInstance.destroy();
            }

            const filteredStats = statistics.filter(item => item.totalAmount > 0);

            if (filteredStats.length === 0) {
                expensePieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['ç„¡æ”¯å‡ºæ•¸æ“š'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#cccccc'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            title: {
                                display: true,
                                text: 'æœ¬æœˆç„¡æ”¯å‡ºæ•¸æ“š',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                });
                return;
            }

            const labels = filteredStats.map(item => item.category);
            const data = filteredStats.map(item => item.totalAmount);
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#C9CBCE', '#A6C887', '#F08080'
            ];

            expensePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ¯æœˆåˆ†é¡æ”¯å‡ºåˆ†ä½ˆ',
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    }
                }
            });
        }

        // ç¹ªè£½é ç®—å°æ¯”ç›´æ¢åœ–
        function renderBudgetComparisonChart(statistics) {
            const ctx = document.getElementById('budgetComparisonChart').getContext('2d');

            if (budgetComparisonChartInstance) {
                budgetComparisonChartInstance.destroy();
            }

            if (statistics.length === 0) {
                budgetComparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ç„¡æ•¸æ“š'],
                        datasets: [{
                            label: 'å¯¦éš›æ”¯å‡º',
                            data: [0],
                            backgroundColor: '#cccccc'
                        }, {
                            label: 'é ç®—',
                            data: [0],
                            backgroundColor: '#999999'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            title: {
                                display: true,
                                text: 'æœ¬æœˆç„¡æ”¯å‡ºæˆ–é ç®—æ•¸æ“š',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'åˆ†é¡',
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'é‡‘é¡',
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            }
                        }
                    }
                });
                return;
            }

            const labels = statistics.map(item => item.category);
            const totalAmounts = statistics.map(item => item.totalAmount);
            const budgetAmounts = statistics.map(item => item.budgetAmount || 0);

            budgetComparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¯¦éš›æ”¯å‡º',
                        data: totalAmounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: 'é ç®—',
                        data: budgetAmounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ¯æœˆåˆ†é¡æ”¯å‡º vs. é ç®—å°æ¯”',
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'åˆ†é¡',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'é‡‘é¡',
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // èªéŸ³è½‰æ–‡å­— (å‚³é€éŸ³è¨Šåˆ°å¾Œç«¯)
        async function sendAudioForTranscription(audioBlob) {
            const formData = new FormData();
            formData.append('audioFile', audioBlob, 'recorded_audio.webm');

            try {
                const res = await fetch(transcribeApiUrl, {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                const msg = document.getElementById('message');

                if (res.ok) {
                    if (data.transcription) {
                        applySpeechResultToForm(data.transcription);
                        showMessage('message', data.message || 'èªéŸ³è½‰æ–‡å­—æˆåŠŸï¼Œè«‹ç¢ºèªè³‡è¨Šã€‚', 'success');
                    } else {
                        showMessage('message', data.message || 'èªéŸ³è­˜åˆ¥çµæœç‚ºç©ºï¼Œè«‹èªªæ¸…æ¥šä¸€é»ã€‚', 'warning');
                    }
                } else {
                    showMessage('message', data.message || 'èªéŸ³è½‰æ–‡å­—å¤±æ•—ã€‚', 'error');
                }
            } catch (error) {
                console.error('ç™¼é€éŸ³è¨Šè‡³å¾Œç«¯å¤±æ•—:', error);
                showMessage('message', 'èªéŸ³è½‰æ–‡å­—æœå‹™é€£ç·šå¤±æ•—ã€‚', 'error');
            } finally {
                toggleLoading('speechLoading', false);
            }
        }

        // å°‡èªéŸ³è¾¨è­˜çµæœå¡«å……åˆ°è¡¨å–®
        function applySpeechResultToForm(speechResult) {
            const titleInput = document.getElementById('title');
            const amountInput = document.getElementById('amount');
            const categorySelect = document.getElementById('category');
            const dateInput = document.getElementById('date');
            const messageDisplay = document.getElementById('message');

            let parsedTitle = speechResult;
            let parsedAmount = null;
            let parsedCategory = null;
            let parsedDate = null;

            const today = new Date();
            const currentYear = today.getFullYear();

            let tempDateMatch;
            const specificDateRegex = /(\d{2,4})[-\/å¹´](\d{1,2})[-\/æœˆ](\d{1,2})(?:æ—¥|è™Ÿ)?/;
            tempDateMatch = parsedTitle.match(specificDateRegex);
            if (tempDateMatch) {
                let year = parseInt(tempDateMatch[1]);
                let month = parseInt(tempDateMatch[2]);
                let day = parseInt(tempDateMatch[3]);
                if (year < 100) { year += 2000; }
                try {
                    const dateObj = new Date(Date.UTC(year, month - 1, day));
                    if (dateObj.getUTCFullYear() === year && (dateObj.getUTCMonth() + 1) === month && dateObj.getUTCDate() === day) {
                        parsedDate = formatDate(dateObj);
                        parsedTitle = parsedTitle.replace(tempDateMatch[0], '').trim();
                    }
                } catch (e) { /* Ignore invalid date */ }
            }

            if (!parsedDate) {
                const monthDayRegex = /(\d{1,2})æœˆ(\d{1,2})(?:æ—¥|è™Ÿ)?/;
                tempDateMatch = parsedTitle.match(monthDayRegex);
                if (tempDateMatch) {
                    let month = parseInt(tempDateMatch[1]);
                    let day = parseInt(tempDateMatch[2]);
                    let year = currentYear;
                    try {
                        const dateObj = new Date(Date.UTC(year, month - 1, day));
                        if (dateObj.getUTCFullYear() === year && (dateObj.getUTCMonth() + 1) === month && dateObj.getUTCDate() === day) {
                            parsedDate = formatDate(dateObj);
                            parsedTitle = parsedTitle.replace(tempDateMatch[0], '').trim();
                        }
                    } catch (e) { /* Ignore invalid date */ }
                }
            }

            if (!parsedDate) {
                const tomorrowDate = new Date(today); tomorrowDate.setDate(today.getDate() + 1);
                const yesterdayDate = new Date(today); yesterdayDate.setDate(today.getDate() - 1);
                const twoDaysAgoDate = new Date(today); twoDaysAgoDate.setDate(today.getDate() - 2);

                if (parsedTitle.includes('ä»Šå¤©')) {
                    parsedDate = formatDate(today);
                    parsedTitle = parsedTitle.replace('ä»Šå¤©', '').trim();
                } else if (parsedTitle.includes('æ˜¨å¤©')) {
                    parsedDate = formatDate(yesterdayDate);
                    parsedTitle = parsedTitle.replace('æ˜¨å¤©', '').trim();
                } else if (parsedTitle.includes('å‰å¤©')) {
                    parsedDate = formatDate(twoDaysAgoDate);
                    parsedTitle = parsedTitle.replace('å‰å¤©', '').trim();
                } else if (parsedTitle.includes('æ˜å¤©')) {
                    parsedDate = formatDate(tomorrowDate);
                    parsedTitle = parsedTitle.replace('æ˜å¤©', '').trim();
                }
            }

            const amountMatch = parsedTitle.match(/(\d+(\.\d+)?)\s*(å…ƒ|å¡ŠéŒ¢|å¡Š|éŒ¢)?/);
            if (amountMatch) {
                parsedAmount = parseFloat(amountMatch[1]);
                parsedTitle = parsedTitle.replace(amountMatch[0], '').trim();
            }

            const availableCategories = Array.from(categorySelect.options).map(opt => opt.value).filter(v => v !== '');
            const categoryKeywords = {
                'é¤é£²': ['é¤é£²', 'åˆé¤', 'æ™šé¤', 'æ—©é¤', 'å’–å•¡', 'é£²æ–™', 'é£Ÿç‰©', 'å¤–è³£', 'é¤å»³', 'åƒ', 'å–', 'é¤', 'é£¯'],
                'äº¤é€š': ['äº¤é€š', 'è¨ˆç¨‹è»Š', 'åŠ æ²¹', 'æ²¹éŒ¢', 'äº¤é€šè²»', 'æ­è»Š', 'è»Š', 'æ·é‹', 'å…¬è»Š'],
                'å¨›æ¨‚': ['å¨›æ¨‚', 'çœ‹é›»å½±', 'å”±æ­Œ', 'éŠæˆ²', 'KTV', 'é›»å½±é™¢', 'ç©'],
                'è³¼ç‰©': ['è³¼ç‰©', 'è²·è¡£æœ', 'è²·é‹å­', 'è²·æ±è¥¿', 'ç™¾è²¨', 'å•†å ´', 'ç¶²è³¼', 'è²·'],
                'ç”Ÿæ´»': ['ç”Ÿæ´»', 'æ°´è²»', 'é›»è²»', 'ç“¦æ–¯è²»', 'æˆ¿ç§Ÿ', 'ç”Ÿæ´»ç”¨å“', 'ç¹³è²»', 'æ—¥ç”¨å“'],
                'å…¶ä»–': ['å…¶ä»–', 'é›œé …', 'å…¶ä»–è²»ç”¨', 'ææ¬¾']
            };

            const sortedKeywords = [];
            for (const categoryName in categoryKeywords) {
                categoryKeywords[categoryName].forEach(keyword => {
                    sortedKeywords.push({ category: categoryName, keyword: keyword });
                });
            }
            sortedKeywords.sort((a, b) => b.keyword.length - a.keyword.length);

            for (const item of sortedKeywords) {
                if (speechResult.includes(item.keyword)) {
                    parsedCategory = item.category;
                    parsedTitle = parsedTitle.replace(new RegExp(item.keyword + '\\s*', 'g'), '').trim();
                    break;
                }
            }

            titleInput.value = parsedTitle || speechResult;
            amountInput.value = parsedAmount !== null ? parsedAmount : '';
            categorySelect.value = (parsedCategory && availableCategories.includes(parsedCategory)) ? parsedCategory : '';
            dateInput.value = parsedDate || formatDate(today);

            if (parsedTitle) titleInput.classList.add('input-highlight');
            if (parsedAmount !== null) amountInput.classList.add('input-highlight');
            if (parsedCategory) categorySelect.classList.add('input-highlight');
            if (parsedDate) dateInput.classList.add('input-highlight');

            setTimeout(() => {
                titleInput.classList.remove('input-highlight');
                amountInput.classList.remove('input-highlight');
                categorySelect.classList.remove('input-highlight');
                dateInput.classList.remove('input-highlight');
            }, 1600);

            let warnings = [];
            if (parsedAmount === null) warnings.push('é‡‘é¡');
            if (!parsedCategory || !availableCategories.includes(parsedCategory)) warnings.push('åˆ†é¡');
            if (!parsedDate) warnings.push('æ—¥æœŸï¼ˆå·²é è¨­ç‚ºä»Šå¤©ï¼‰');

            if (warnings.length > 0) {
                showMessage('message', `èªéŸ³è§£æå®Œæˆï¼Œä½†ä»¥ä¸‹è³‡è¨Šå¯èƒ½ä¸å®Œæ•´æˆ–å·²é è¨­ï¼š${warnings.join('ã€')}ã€‚è«‹æª¢æŸ¥ä¸¦è£œé½Šè³‡è¨Šã€‚`, 'warning');
            } else {
                showMessage('message', 'èªéŸ³è§£ææˆåŠŸï¼Œè«‹ç¢ºèªè³‡è¨Šå¾Œæäº¤ã€‚', 'success');
            }
        }

        // --- CSV åŒ¯å…¥ç›¸é—œçš„ JavaScript é‚è¼¯ ---
        let parsedCsvData = [];

        async function processCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('importMessage', 'è«‹é¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆã€‚', 'warning');
                return;
            }

            toggleLoading('importLoading', true);
            toggleButtonDisabled('processCsvButton', true);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').map(line => line.trim()).filter(Boolean);

                    if (lines.length < 1) {
                        showMessage('importMessage', 'CSV æª”æ¡ˆå…§å®¹ç‚ºç©ºã€‚', 'error');
                        return;
                    }

                    const [headerLine, ...dataLines] = lines;
                    const headers = headerLine.split(',').map(h => h.trim());
                    const mapping = guessColumnMapping(headers);

                    if (
                        mapping.title === undefined ||
                        mapping.amount === undefined ||
                        mapping.category === undefined ||
                        mapping.date === undefined
                    ) {
                        showMessage('importMessage', 'CSV æª”æ¡ˆç¼ºå°‘å¿…è¦çš„æ¬„ä½ï¼ˆæ¨™é¡Œã€é‡‘é¡ã€åˆ†é¡ã€æ—¥æœŸï¼‰ã€‚', 'error');
                        return;
                    }

                    parsedCsvData = dataLines.map(line => {
                        const cols = line.split(',').map(c => c.trim());
                        const rawDate = cols[mapping.date];
                        let formattedDate = null;
                        if (rawDate) {
                            const dateObj = new Date(rawDate);
                            if (!isNaN(dateObj) && dateObj.getFullYear() > 1900) {
                                formattedDate = dateObj.toISOString().split('T')[0];
                            }
                        }

                        return {
                            title: cols[mapping.title] || '',
                            amount: parseFloat(cols[mapping.amount]) || 0,
                            category: cols[mapping.category] || 'å…¶ä»–',
                            date: formattedDate
                        };
                    }).filter(data => data.date !== null);

                    displayCsvPreview(headers, parsedCsvData.slice(0, 5), mapping);
                    document.getElementById('confirm-import').style.display = 'block';
                    document.getElementById('preview-area').style.display = 'block';
                    showMessage('importMessage', `å·²æˆåŠŸè§£æ ${parsedCsvData.length} ç­†è³‡æ–™ã€‚è«‹ç¢ºèªå¾ŒåŒ¯å…¥ã€‚`, 'info');

                } catch (error) {
                    console.error('è§£æ CSV å¤±æ•—:', error);
                    showMessage('importMessage', `è§£æ CSV å¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚`, 'error');
                } finally {
                    toggleLoading('importLoading', false);
                    toggleButtonDisabled('processCsvButton', false);
                }
            };
            reader.readAsText(file);
        }

        function displayCsvPreview(headers, data, mapping) {
            const previewTableHead = document.querySelector('#csvPreviewTable thead tr');
            const previewTableBody = document.querySelector('#csvPreviewTable tbody');
            previewTableHead.innerHTML = '';
            previewTableBody.innerHTML = '';

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                previewTableHead.appendChild(th);
            });

            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((header, index) => {
                    const td = document.createElement('td');
                    let cellText = '';
                    let isMapped = false;
                    if (mapping.title === index) { cellText = row.title; isMapped = true; }
                    else if (mapping.amount === index) { cellText = row.amount.toFixed(2); isMapped = true; }
                    else if (mapping.category === index) { cellText = row.category; isMapped = true; }
                    else if (mapping.date === index) { cellText = row.date; isMapped = true; }
                    else {
                        cellText = "N/A";
                    }
                    td.textContent = cellText;
                    if (isMapped) {
                        td.style.backgroundColor = 'rgba(144, 238, 144, 0.3)';
                    }
                    tr.appendChild(td);
                });
                tr.addEventListener('click', () => {
                    console.log('Clicked row data:', row);
                });
                previewTableBody.appendChild(tr);
            });
        }

        // è‡ªå‹•æ¬„ä½å°æ‡‰å‡½å¼
        function guessColumnMapping(headerRow) {
            const mapping = {};
            headerRow.forEach((col, idx) => {
                const key = col.trim().toLowerCase();

                if (key.includes("id")) {
                    mapping.id = idx;
                }

                if (key.includes("é‡‘é¡") || key.includes("amount") || key.includes("ç¸½è¨ˆ")) {
                    mapping.amount = idx;
                } else if (
                    key.includes("æ—¥æœŸ") || key.includes("date") ||
                    key.includes("è¨˜å¸³") || key.includes("æ™‚é–“")
                ) {
                    if (!mapping.date) mapping.date = idx;
                } else if (
                    key.includes("æ¨™é¡Œ") || key.includes("title") ||
                    key.includes("å‚™è¨»") || key.includes("èªªæ˜") || key.includes("å…§å®¹")
                ) {
                    mapping.title = idx;
                } else if (
                    key.includes("åˆ†é¡") || key.includes("category") || key.includes("é¡åˆ¥")
                ) {
                    if (mapping.category === undefined) mapping.category = idx;
                    else if (mapping.subcategory === undefined) mapping.subcategory = idx;
                }
            });
            return mapping;
        }

        async function confirmImport() {
            if (parsedCsvData.length === 0) {
                showMessage('importMessage', 'æ²’æœ‰è¦åŒ¯å…¥çš„è³‡æ–™ã€‚è«‹å…ˆé¸æ“‡ä¸¦è§£æ CSV æª”æ¡ˆã€‚', 'warning');
                return;
            }

            toggleLoading('importLoading', true);
            toggleButtonDisabled('confirm-import', true);

            let existingExpenses = [];
            try {
                const res = await fetch("/api/expenses");
                existingExpenses = await res.json();
            } catch (err) {
                showMessage('importMessage', 'ç„¡æ³•å–å¾—ç¾æœ‰è³‡æ–™ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™ï¼', 'error');
                toggleLoading('importLoading', false);
                toggleButtonDisabled('confirm-import', false);
                return;
            }

            const newExpensesToImport = parsedCsvData.filter(exp => {
                return !existingExpenses.some(e =>
                    e.title === exp.title &&
                    parseFloat(e.amount) === exp.amount &&
                    e.category === exp.category &&
                    e.date === exp.date
                );
            });

            if (newExpensesToImport.length === 0) {
                showMessage('importMessage', "æ‰€æœ‰è³‡æ–™éƒ½å·²å­˜åœ¨ï¼Œæ²’æœ‰éœ€è¦åŒ¯å…¥çš„æ–°è³‡æ–™ï¼", 'info');
                toggleLoading('importLoading', false);
                toggleButtonDisabled('confirm-import', false);
                return;
            }

            let successCount = 0;
            let failCount = 0;
            for (const exp of newExpensesToImport) {
                if (!exp.title || isNaN(exp.amount) || !exp.category || !exp.date) {
                    console.warn("è·³éç„¡æ•ˆçš„åŒ¯å…¥è³‡æ–™:", exp);
                    failCount++;
                    continue;
                }

                try {
                    const res = await fetch("/api/expenses", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(exp)
                    });

                    if (res.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error("åŒ¯å…¥å–®ç­†å¤±æ•—ï¼š", exp, await res.text());
                    }
                } catch (err) {
                    failCount++;
                    console.error("åŒ¯å…¥å–®ç­†å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ï¼‰ï¼š", exp, err);
                }
            }

            showMessage('importMessage', `åŒ¯å…¥å®Œæˆï¼æˆåŠŸ ${successCount} ç­†ï¼Œå¤±æ•— ${failCount} ç­†ã€‚ï¼ˆå·²è‡ªå‹•ç•¥éé‡è¤‡è³‡æ–™ï¼‰`, successCount > 0 ? 'success' : 'warning');

            document.getElementById('csvFileInput').value = '';
            document.getElementById('processCsvButton').style.display = 'none';
            document.getElementById('confirm-import').style.display = 'none';
            document.getElementById('preview-area').style.display = 'none';
            parsedCsvData = [];

            queryExpenses();
            loadCategoryBudgets();
            loadMonthlyStatistics();

            toggleLoading('importLoading', false);
            toggleButtonDisabled('confirm-import', false);
        }

        // åŒ¯å‡º CSV åŠŸèƒ½
        function exportVisibleTableToCSV() {
            const rows = [];
            const headers = ["ID", "æ¨™é¡Œ", "é‡‘é¡", "åˆ†é¡", "æ—¥æœŸ"];
            rows.push(headers);

            const tableRows = document.querySelectorAll("#expenseTableBody tr");
            tableRows.forEach(tr => {
                const cells = Array.from(tr.querySelectorAll("td")).slice(0, 5).map(td => td.textContent.trim());
                rows.push(cells);
            });

            const csvContent = rows.map(row => row.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "æ”¯å‡ºç´€éŒ„.csv");
            link.click();
        }


        // --- DOMContentLoaded ç›£è½å™¨ (é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ) ---
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ–°å¢æ”¯å‡ºè¡¨å–®çš„æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            // è¨­ç½®é ç®—å’Œçµ±è¨ˆå€å¡Šçš„é è¨­å¹´ä»½å’Œæœˆä»½ç‚ºç•¶å‰æ™‚é–“
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            document.getElementById('cbYear').value = currentYear;
            document.getElementById('cbMonth').value = currentMonth;
            document.getElementById('statYear').value = currentYear;
            document.getElementById('statMonth').value = currentMonth;

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            document.getElementById('expenseForm').addEventListener('submit', addExpenseHandler);
            document.getElementById('categoryBudgetForm').addEventListener('submit', categoryBudgetHandler);
            document.getElementById('editForm').addEventListener('submit', editFormHandler);
            document.getElementById('loadStatsButton').addEventListener('click', loadMonthlyStatistics);
            document.getElementById('queryExpensesButton').addEventListener('click', queryExpenses);
            document.getElementById('resetExpensesButton').addEventListener('click', resetExpenses);
            document.getElementById('processCsvButton').addEventListener('click', processCSV);
            document.getElementById('confirm-import').addEventListener('click', confirmImport);
            document.getElementById('csvFileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('processCsvButton').style.display = 'block';
                    document.getElementById('confirm-import').style.display = 'none';
                    document.getElementById('preview-area').style.display = 'none';
                    showMessage('importMessage', '', '');
                } else {
                    document.getElementById('processCsvButton').style.display = 'none';
                }
            });


            // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
            const toggleButton = document.getElementById("toggle-theme");

            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                toggleButton.innerText = "ğŸŒ™ æ·±è‰²æ¨¡å¼";
            } else {
                document.body.classList.remove("dark-mode");
                toggleButton.innerText = "â˜€ï¸ æ·ºè‰²æ¨¡å¼";
            }

            toggleButton.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");

                if (document.body.classList.contains("dark-mode")) {
                    toggleButton.innerText = "ğŸŒ™ æ·±è‰²æ¨¡å¼";
                } else {
                    toggleButton.innerText = "â˜€ï¸ æ·ºè‰²æ¨¡å¼";
                }

                localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");

                if (document.getElementById('statistics-page').style.display !== 'none') {
                     loadMonthlyStatistics();
                }
            });

            // ç‚ºå°è¦½åˆ—é€£çµæ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageId = event.target.closest('.nav-link').dataset.page;
                    showPage(pageId);
                });
            });

            // åˆå§‹åŒ–èªéŸ³è¼¸å…¥æŒ‰éˆ•ç‹€æ…‹
            const speechInputButton = document.getElementById('speechInputButton');
            const stopSpeechInputButton = document.getElementById('stopSpeechInputButton');
            const speechLoading = document.getElementById('speechLoading');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                speechInputButton.style.display = 'none';
                stopSpeechInputButton.style.display = 'none';
                showMessage('message', 'æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéº¥å…‹é¢¨éŒ„éŸ³åŠŸèƒ½ã€‚è«‹ä½¿ç”¨ Chrome æˆ–å…¶ä»–å…¼å®¹ç€è¦½å™¨ã€‚', 'error');
            }

            let streamRef = null;

            speechInputButton.addEventListener('click', async () => {
                try {
                    streamRef = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(streamRef, { mimeType: 'audio/webm; codecs=opus' });

                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        toggleLoading('speechLoading', true);
                        showMessage('message', 'èªéŸ³éŒ„è£½å®Œæˆï¼Œæ­£åœ¨è­˜åˆ¥ä¸­...', 'info');

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                        await sendAudioForTranscription(audioBlob);

                        if (streamRef) {
                            streamRef.getTracks().forEach(track => track.stop());
                        }
                        speechInputButton.style.display = 'block';
                        stopSpeechInputButton.style.display = 'none';
                        speechInputButton.classList.remove('recording');
                        toggleLoading('speechLoading', false);
                    };

                    mediaRecorder.start();
                    showMessage('message', 'è«‹é–‹å§‹èªªè©±... (é»æ“Šã€Œåœæ­¢èªéŸ³è¼¸å…¥ã€æŒ‰éˆ•çµæŸ)', 'info');
                    speechInputButton.style.display = 'none';
                    stopSpeechInputButton.style.display = 'block';
                    speechInputButton.classList.add('recording');

                } catch (err) {
                    console.error('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:', err);
                    showMessage('message', 'ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨éº¥å…‹é¢¨ã€‚', 'error');
                    speechInputButton.classList.remove('recording');
                    toggleLoading('speechLoading', false);
                }
            });

            stopSpeechInputButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            });

            // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹é é¢
            showPage('add-expense-page');
        });
    </script>
</body>
</html>